<div class="dashboard-root">
  <div class="network-bg" aria-hidden="true"></div>

  <header class="top-bar">
    <div class="left">
      <h1 class="title">Central AI Model</h1>
    </div>
    <div class="right">
      <div class="avatar-container">
        <div class="avatar" aria-hidden="true" (click)="toggleProfileMenu()">
          <mat-icon>account_circle</mat-icon>
        </div>
        <div class="profile-menu" *ngIf="showProfileMenu">
          <div class="menu-item" (click)="viewClientProgress()">Access Client Progress</div>
          <div class="menu-item" (click)="openAccountSettings()">Account Settings</div>
          <div class="menu-item" (click)="openHelp()">Help</div>
          <div class="menu-item" (click)="signOut()">Sign Out</div>
        </div>
      </div>
    </div>
  </header>

  <main class="card-wrap">
    <!-- default clients view (kept intact) -->
    <section class="clients-card" *ngIf="!showClientProgress">
      <div class="card-header">
        <div class="card-title">Client Hospitals</div>
        <button mat-flat-button color="primary" class="distribute-btn" (click)="distributeModel()">Distribute Model</button>
      </div>

      <table class="clients-table">
        <thead>
          <tr>
            <th>Client ID</th>
            <th>Hospital Name</th>
            <th>Data Size</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of clients; let i = index">
            <td class="id-cell">{{ c.clientId || ('CID' + (i+1)) }}</td>
            <td class="name-cell">{{ c.name }}</td>
            <td>{{ c.dataSize }}</td>
            <td>
              <span class="status-wrap">
                <mat-icon class="status-icon {{ getStatusClass(c.status) }}">{{ getStatusIcon(c.status) }}</mat-icon>
                <span class="status-label">{{ c.status }}</span>
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="card-footer">System Status: AI systems operational. Last update: 5 minutes ago</div>
    </section>

    <!-- Access Client Progress view -->
    <section class="client-progress-container" *ngIf="showClientProgress">
      <div class="progress-header">
        <button mat-stroked-button class="back-btn-top" (click)="closeClientProgress()">Back</button>
      </div>

      <div class="progress-top">
        <div class="tabs">
          <div class="tab" [class.active]="activeTab==='basic'" (click)="setActiveTab('basic')">Basic List View</div>
          <div class="tab" [class.active]="activeTab==='interactive'" (click)="setActiveTab('interactive')">Round-by-Round Interactive</div>
          <div class="tab" [class.active]="activeTab==='diagnostic'" (click)="setActiveTab('diagnostic')">Detailed Client Diagnostic</div>
        </div>
      </div>

      

      <div class="progress-body">
        <!-- Basic List View -->
        <div *ngIf="activeTab==='basic'" class="progress-left">
          <div class="progress-table-card">
            <table class="progress-table">
              <thead>
                <tr>
                  <th>Client ID</th>
                  <th>Status</th>
                  <th>Last Active<br/>(Round)</th>
                  <th>Latest<br/>Accuracy</th>
                  <th>Data Size<br/>(Samples)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of clients; let i = index">
                  <td>{{ c.clientId || (('00' + (i+1)).slice(-3) + (['A','B','C','D','E'][i] || 'X')) }}</td>
                  <td>
                    <span class="badge" [ngClass]="{ 'badge-completed': i===1, 'badge-failed': i===2, 'badge-training': i===4 }">
                      {{ i===1 ? 'Completed' : (i===2 ? 'Failed/Timeout' : (i===4 ? 'Training' : (c.status || '4'))) }}
                    </span>
                  </td>
                  <td>{{ getRandomActive(i) }}</td>
                  <td>{{ c.accuracy || 'N/A' }}</td>
                  <td>{{ getRandomSampleSize(i) | number }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="performance-trends">
            <h3>Round 4 Performance Trends</h3>
            <div class="small-charts">
              <div class="chart-card">Client Loss Distribution (placeholder)</div>
              <div class="chart-card">Client Loss Distribution (placeholder)</div>
            </div>
          </div>
        </div>

        <!-- Interactive View -->
        <div *ngIf="activeTab==='interactive'" class="progress-left interactive-rows">
          <div *ngFor="let round of rounds" class="round-row">
            <div class="summary-card">
              <div class="summary-header">Federated Round {{ round.roundNumber }} Summary</div>
              <table class="summary-table">
                <thead>
                  <tr>
                    <th>Client ID</th>
                    <th>Training Time</th>
                    <th>Model Size (MB)</th>
                    <th>Local Model Diff Norm</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let e of round.entries | slice:0:5">
                    <td>{{ e.clientId }}</td>
                    <td>{{ e.trainingTime }}</td>
                    <td>{{ e.modelSizeMB }}</td>
                    <td [ngClass]="{ 'best': getBestLocalDiff(round) !== null && e.localDiffNorm === getBestLocalDiff(round) }">{{ e.localDiffNorm | number:'1.3-3' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="summary-metrics">
              <div class="metrics-card small-metrics">
                <div class="metric-title">Global Model Metrics</div>
                <div class="metric-row">
                  <div class="metric-label">Round {{ round.roundNumber }} Global Loss</div>
                  <div class="metric-value">{{ round.global.loss }}</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Round {{ round.roundNumber }} Global Accuracy</div>
                  <div class="metric-value">{{ round.global.accuracy }}</div>
                </div>
                <div class="completion small">
                  <div class="completion-label">Client Completion</div>
                  <div class="completion-ring small-ring">
                    <div class="ring-inner" [ngStyle]="getRingStyle(round.global.completionRate)">{{ round.global.completionRate }}%</div>
                  </div>
                </div>
                <div class="round-time">Round Time Elapsed: {{ round.global.timeElapsed }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagnostic View -->
        <div *ngIf="activeTab==='diagnostic'" class="progress-left diagnostic-view">

          <div class="diagnostic-selector" style="display: flex; gap: 24px; align-items: center;">
            <div>
              <label>Select Client:</label>
              <select (change)="selectDiagnosticClient($any($event.target).value)" [value]="selectedDiagnosticClient || ''">
                <option value="" disabled>Choose a client</option>
                <option *ngFor="let c of clients" [value]="c.clientId || c.name">{{ c.clientId || c.name }}</option>
              </select>
            </div>
            <div *ngIf="selectedDiagnosticClient">
              <label>Select Round:</label>
              <select (change)="selectDiagnosticRound($any($event.target).value)" [value]="selectedDiagnosticRound">
                <option *ngFor="let r of rounds" [value]="r.roundNumber">Round {{ r.roundNumber }}</option>
              </select>
            </div>
          </div>

          <div *ngIf="selectedDiagnosticClient" class="diagnostic-content">
            <div class="diagnostic-top-row">
              <div class="diagnostic-metrics">
                <h4>Performance Metrics</h4>
                <div class="metric-stat">
                  <span>Current Loss:</span>
                  <strong>{{ diagnosticData.performanceHistory && diagnosticData.performanceHistory[0] ? diagnosticData.performanceHistory[0].loss : 'N/A' }}</strong>
                </div>
                <div class="metric-stat">
                  <span>Training Status:</span>
                  <strong>Active</strong>
                </div>
              </div>

              <div class="failure-log">
                <h4>Failure & Debugging Log</h4>
                <table class="log-table">
                  <thead>
                    <tr>
                      <th>Round</th>
                      <th>Type</th>
                      <th>Timespan</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let log of diagnosticData.failureLog">
                      <td>{{ log.round }}</td>
                      <td>{{ log.type }}</td>
                      <td>{{ log.timespain }}</td>
                      <td>{{ log.details }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="diagnostic-bottom-row">
              <div class="failure-chart">
                <h4>Disconnection/Failure Rate</h4>
                <div class="bar-chart-placeholder">
                  <div *ngFor="let d of diagnosticData.disconnectionRates" class="bar-item">
                    <div class="bar" [style.height.%]="d.rate * 10"></div>
                    <span>{{ d.round }}</span>
                  </div>
                </div>
              </div>

              <div class="metrics-card global-metrics">
                <h4>Global Model Metrics after final round</h4>
                <div class="metric-row">
                  <div class="metric-label">Global Loss</div>
                  <div class="metric-value">0.421</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Global Accuracy</div>
                  <div class="metric-value">89.8%</div>
                </div>

                <div class="completion small-completion">
                  <div class="completion-label">Client Completion Rate</div>
                  <div class="completion-ring small-ring">
                    <div class="ring-inner" [ngStyle]="getRingStyle(getLatestCompletionRate())">{{ getLatestCompletionRate() }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="progress-actions">
        <button mat-stroked-button (click)="closeClientProgress()">Back</button>
      </div>
    </section>
  </main>
</div>
