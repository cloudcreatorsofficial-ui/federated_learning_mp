<div class="dashboard-root">
  <div class="network-bg" aria-hidden="true"></div>

  <header class="top-bar">
    <div class="left">
      <h1 class="title">Central AI Model</h1>
    </div>
    <div class="right">
      <div class="avatar-container">
        <div class="avatar" aria-hidden="true" (click)="toggleProfileMenu()">
          <mat-icon>account_circle</mat-icon>
        </div>
        <div class="profile-menu" *ngIf="showProfileMenu">
          <div class="menu-item" (click)="viewClientProgress()">Access Client Progress</div>
          <div class="menu-item" (click)="openAccountSettings()">Account Settings</div>
          <div class="menu-item" (click)="openHelp()">Help</div>
          <div class="menu-item" (click)="signOut()">Sign Out</div>
        </div>
      </div>
    </div>
  </header>

  <main class="card-wrap">
    <!-- default clients view (kept intact) -->
    <section class="clients-card" *ngIf="!showClientProgress">
      <div class="card-header">
        <div class="card-title">Client Hospitals</div>
        <button mat-flat-button color="primary" class="distribute-btn" (click)="distributeModel()">Distribute Model</button>
      </div>

      <table class="clients-table">
        <thead>
          <tr>
            <th>Client ID</th>
            <th>Hospital Name</th>
            <th>Data Size</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of clients; let i = index">
            <td class="id-cell">{{ c.clientId || ('CID' + (i+1)) }}</td>
            <td class="name-cell">{{ c.name }}</td>
            <td>{{ c.dataSize }}</td>
            <td>
              <span class="status-wrap">
                <mat-icon class="status-icon {{ getStatusClass(c.status) }}">{{ getStatusIcon(c.status) }}</mat-icon>
                <span class="status-label">{{ c.status }}</span>
              </span>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="card-footer">System Status: AI systems operational. Last update: 5 minutes ago</div>
    </section>

    <!-- Access Client Progress view -->
    <section class="client-progress-container" *ngIf="showClientProgress">
      <div class="progress-header">
        <button mat-stroked-button class="back-btn-top" (click)="closeClientProgress()">Back</button>
      </div>

      <div class="progress-top">
        <div class="tabs">
          <div class="tab" [class.active]="activeTab==='basic'" (click)="setActiveTab('basic')">Basic List View</div>
          <div class="tab" [class.active]="activeTab==='interactive'" (click)="setActiveTab('interactive')">Round-by-Round Interactive</div>
          <div class="tab" [class.active]="activeTab==='diagnostic'" (click)="setActiveTab('diagnostic')">Detailed Client Diagnostic</div>
        </div>
      </div>

      

      <div class="progress-body">
        <!-- Basic List View -->
        <div *ngIf="activeTab==='basic'" class="progress-left">
          <div class="progress-table-card">
            <table class="progress-table">
              <thead>
                <tr>
                  <th>Client ID</th>
                  <th>Status</th>
                  <th>Last Active<br/>(Round)</th>
                  <th>Latest<br/>Accuracy</th>
                  <th>Data Size<br/>(Samples)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of clients.slice(0, 3); let i = index">
                  <td>{{ c.clientId }}</td>
                  <td>
                    <span class="badge" [ngClass]="{ 'badge-completed': c.status === 'Active', 'badge-training': c.status === 'Deployed (Awaiting Ack)', 'badge-awaiting': c.status === 'Awaiting Model' }">
                      {{ c.status }}
                    </span>
                  </td>
                  <td>Round {{ (i + 1) * 2 }}</td>
                  <td>{{ c.accuracy || 'N/A' }}</td>
                  <td>{{ (2500 + i * 1200) | number }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="performance-trends">
            <h3>Round 4 Performance Trends</h3>
            <div class="small-charts">
              <div class="chart-card">Client Loss Distribution (placeholder)</div>
              <div class="chart-card">Client Loss Distribution (placeholder)</div>
            </div>
          </div>
        </div>

        <!-- Interactive View -->
        <div *ngIf="activeTab==='interactive'" class="progress-left interactive-rows">
          <div *ngFor="let round of rounds; let last = last" class="round-section">
            <!-- Top Row: Summary and Metrics -->
            <div class="round-top-row">
              <div class="summary-card">
                <div class="summary-header">Federated Round {{ round.roundNumber }} - {{ last ? 'In Progress' : 'Completed' }}</div>
                <table class="summary-table">
                  <thead>
                    <tr>
                      <th>Client ID</th>
                      <th>Training Time</th>
                      <th>Model Size (MB)</th>
                      <th>Loss</th>
                      <th>Accuracy</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let client of round.clients">
                      <td>{{ client.id }}</td>
                      <td>{{ client.trainingTime }}</td>
                      <td>{{ client.modelSize }}</td>
                      <td>{{ client.loss | number:'1.2-3' }}</td>
                      <td>{{ client.accuracy | number:'1.1-1' }}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="summary-metrics">
                <div class="metrics-card small-metrics">
                  <div class="metric-title">Global Model Metrics - Round {{ round.roundNumber }}</div>
                  <div class="metric-row">
                    <div class="metric-label">Global Loss</div>
                    <div class="metric-value">{{ round.global.loss | number:'1.3-3' }}</div>
                  </div>
                  <div class="metric-row">
                    <div class="metric-label">Global Accuracy</div>
                    <div class="metric-value">{{ round.global.accuracy | number:'1.1-1' }}%</div>
                  </div>
                  <div class="completion small">
                    <div class="completion-label">Client Completion</div>
                    <div class="completion-ring small-ring">
                      <div class="ring-inner" [ngStyle]="getRingStyle(round.global.completionRate)">{{ round.global.completionRate }}%</div>
                    </div>
                  </div>
                  <div class="round-time">Round Time Elapsed: {{ round.global.timeElapsed }}</div>
                </div>
              </div>
            </div>

            <!-- Bottom Row: Analysis Charts (Full Width) -->
            <div class="analysis-charts">
              <div class="chart-row">
                <div class="chart-card training-time-chart">
                  <h4>Client Training Time Distribution (Round {{ round.roundNumber }})</h4>
                  <div class="horizontal-bars">
                    <div *ngFor="let client of round.clients" class="bar-row">
                      <span class="client-label">{{ client.id }}</span>
                      <div class="bar-container">
                        <div class="bar" [style.width.%]="(parseTrainingSeconds(client.trainingTime) / 60) * 100"></div>
                      </div>
                      <span class="bar-value">{{ client.trainingTime }}</span>
                    </div>
                  </div>
                </div>

                <div class="chart-card loss-distribution-chart">
                  <h4>Client Loss Distribution Over Time</h4>
                  <div class="line-chart-placeholder">
                    <svg viewBox="0 0 400 200" class="line-chart">
                      <!-- Y-axis labels -->
                      <text x="30" y="20" class="chart-label">10%</text>
                      <text x="30" y="90" class="chart-label">5%</text>
                      <text x="30" y="160" class="chart-label">0%</text>
                      
                      <!-- Y-axis line -->
                      <line x1="35" y1="10" x2="35" y2="170" stroke="#fff" stroke-width="0.5" opacity="0.3"/>
                      
                      <!-- X-axis line -->
                      <line x1="35" y1="170" x2="390" y2="170" stroke="#fff" stroke-width="0.5" opacity="0.3"/>
                      
                      <!-- Grid lines -->
                      <line x1="35" y1="90" x2="390" y2="90" stroke="#fff" stroke-width="0.5" opacity="0.1"/>
                      
                      <!-- Data lines for each client -->
                      <polyline *ngFor="let client of round.clients; let i = index" 
                                [attr.points]="getChartPoints(round.clients, i)" 
                                class="data-line" 
                                [ngStyle]="{'stroke': getClientColor(i)}"/>
                      
                      <!-- Data points -->
                      <circle *ngFor="let client of round.clients; let i = index" 
                              [attr.cx]="80 + (i * 100)"
                              [attr.cy]="170 - (client.loss * 50)"
                              r="3"
                              [ngStyle]="{'fill': getClientColor(i), 'opacity': 0.8}"/>
                      
                      <!-- X-axis labels -->
                      <text *ngFor="let client of round.clients; let i = index" 
                            [attr.x]="80 + (i * 100)" 
                            y="190" 
                            class="chart-label">{{ client.id }}</text>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagnostic View -->
        <div *ngIf="activeTab==='diagnostic'" class="progress-left diagnostic-view">

          <div class="diagnostic-selector" style="display: flex; gap: 24px; align-items: center;">
            <div>
              <label>Select Client:</label>
              <select (change)="selectDiagnosticClient($any($event.target).value)" [value]="selectedDiagnosticClient || ''">
                <option value="" disabled>Choose a client</option>
                <option *ngFor="let c of clients.slice(0, 3); let i = index" [value]="c.id">{{ c.clientId }} - {{ c.name }}</option>
              </select>
            </div>
            <div *ngIf="selectedDiagnosticClient">
              <label>Select Round:</label>
              <select (change)="selectDiagnosticRound($any($event.target).value)" [value]="selectedDiagnosticRound">
                <option *ngFor="let r of rounds" [value]="r.roundNumber">Round {{ r.roundNumber }}</option>
              </select>
            </div>
          </div>

          <div *ngIf="selectedDiagnosticClient" class="diagnostic-content">
            <div class="diagnostic-top-row">
              <div class="diagnostic-metrics">
                <h4>Client Performance - Round {{ selectedDiagnosticRound || 'Latest' }}</h4>
                <div class="metric-stat">
                  <span>Client ID:</span>
                  <strong>{{ diagnosticData.clientId }}</strong>
                </div>
                <div class="metric-stat">
                  <span>Status:</span>
                  <strong>{{ diagnosticData.status }}</strong>
                </div>
                <div class="metric-stat">
                  <span>Current Loss:</span>
                  <strong>{{ diagnosticData.loss | number:'1.3-3' }}</strong>
                </div>
                <div class="metric-stat">
                  <span>Accuracy:</span>
                  <strong>{{ diagnosticData.accuracy | number:'1.1-1' }}%</strong>
                </div>
                <div class="metric-stat">
                  <span>Training Time:</span>
                  <strong>{{ diagnosticData.trainingTime }}</strong>
                </div>
              </div>

              <div class="failure-log">
                <h4>Client Data Summary</h4>
                <table class="log-table">
                  <thead>
                    <tr>
                      <th>Round</th>
                      <th>Loss</th>
                      <th>Accuracy</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let r of rounds">
                      <td>{{ r.roundNumber }}</td>
                      <td>{{ r.global?.loss | number:'1.3-3' }}</td>
                      <td>{{ r.global?.accuracy | number:'1.1-1' }}%</td>
                      <td>
                        <span class="badge badge-completed">Completed</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="diagnostic-bottom-row">
              <div class="failure-chart">
                <h4>Loss Trend Across Rounds</h4>
                <div class="bar-chart-placeholder">
                  <div *ngFor="let r of rounds" class="bar-item">
                    <div class="bar" [style.height.%]="(r.global?.loss || 0) * 100"></div>
                    <span>R{{ r.roundNumber }}</span>
                  </div>
                </div>
              </div>

              <div class="metrics-card global-metrics">
                <h4>Latest Global Model Metrics</h4>
                <div class="metric-row">
                  <div class="metric-label">Global Loss</div>
                  <div class="metric-value">0.421</div>
                </div>
                <div class="metric-row">
                  <div class="metric-label">Global Accuracy</div>
                  <div class="metric-value">89.8%</div>
                </div>

                <div class="completion small-completion">
                  <div class="completion-label">Client Completion Rate</div>
                  <div class="completion-ring small-ring">
                    <div class="ring-inner" [ngStyle]="getRingStyle(getLatestCompletionRate())">{{ getLatestCompletionRate() }}%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="progress-actions">
        <button mat-stroked-button (click)="closeClientProgress()">Back</button>
      </div>
    </section>
  </main>
</div>
